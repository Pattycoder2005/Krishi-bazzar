<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Products — Seller</title>
  <link rel="stylesheet" href="style.css">
  
  <style>
    .container { max-width:1100px; margin:1.5rem auto; padding:1rem; }
    .grid { display:grid; gap:1rem; grid-template-columns: 1fr 1fr; }
    .card { background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    input, textarea { width:100%; padding:.6rem; margin-top:.4rem; border:1px solid #ddd; border-radius:6px; }
    button { background:#0b7b3b; color:white; padding:.6rem .9rem; border:0; border-radius:6px; cursor:pointer; }
    .muted { color:#666; font-size:.9rem; }
    .product-list { margin-top:1rem; display:grid; gap:.75rem; }
    .prod-row { display:flex; justify-content:space-between; gap:1rem; align-items:center; padding:.6rem; border:1px solid #eee; border-radius:6px; }
    .prod-info { flex:1; }
    .prod-actions button { margin-left:.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Manage Products</h1>
    <p class="muted">Add new organic products (only sellers should use this page).</p>

    <div class="card">
      <h3>Add Product</h3>
      <form id="addForm">
        <label>Product name</label>
        <input id="pName" required>
        <label>Description</label>
        <textarea id="pDesc" rows="3"></textarea>
        <label>Price (number)</label>
        <input id="pPrice" type="number" step="0.01" required>
        <label>Purchase link (optional)</label>
        <input id="pLink" type="url" placeholder="https://...">
        <div style="margin-top:.6rem;">
          <button type="submit">Add Product</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:1rem;">
      <h3>Your Products</h3>
      <div id="productList" class="product-list">Loading…</div>
    </div>

    <p style="margin-top:1rem;"><a href="seller-dashboard.html">Back to Dashboard</a></p>
  </div>

  <script>
    const addForm = document.getElementById('addForm');
    const productList = document.getElementById('productList');

    function loggedUserEmail() {
      const u = JSON.parse(localStorage.getItem('loggedInUser'));
      return u?.email || '';
    }

    async function loadProducts() {
      const res = await fetch('/api/products');
      const data = await res.json();
      // show only seller products for this page
      const sellerEmail = loggedUserEmail();
      const list = data.filter(p => p.sellerEmail === sellerEmail);
      if (!list.length) {
        productList.innerHTML = '<p>No products yet.</p>';
        return;
      }
      productList.innerHTML = '';
      list.forEach(p => {
        const row = document.createElement('div');
        row.className = 'prod-row';
        row.innerHTML = `
          <div class="prod-info">
            <strong>${p.name}</strong> <div class="muted">₹ ${p.price} • ${p.desc}</div>
            <div class="muted">ID: ${p.id}</div>
          </div>
          <div class="prod-actions">
            <button data-id="${p.id}" class="editBtn">Edit</button>
            <button data-id="${p.id}" class="delBtn">Delete</button>
          </div>
        `;
        productList.appendChild(row);
      });

      // attach handlers
      document.querySelectorAll('.delBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Delete this product?')) return;
          const id = btn.dataset.id;
          await fetch('/api/products/' + id, { method: 'DELETE' });
          loadProducts();
        });
      });

      document.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const name = prompt('New name:');
          if (name === null) return;
          const desc = prompt('New description:');
          const price = prompt('New price:');
          const link = prompt('New link (or blank):');
          await fetch('/api/products/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, desc, price, link })
          });
          loadProducts();
        });
      });
    }

    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('pName').value.trim();
      const desc = document.getElementById('pDesc').value.trim();
      const price = document.getElementById('pPrice').value;
      const link = document.getElementById('pLink').value.trim();
      const sellerEmail = loggedUserEmail();
      if (!sellerEmail) {
        alert('You must be logged in as a seller to add products.');
        return;
      }

      const res = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, desc, price, link, sellerEmail })
      });
      const data = await res.json();
      if (data.success) {
        addForm.reset();
        loadProducts();
        alert('Product added');
      } else {
        alert('Failed to add product');
      }
    });

    // initial load
    loadProducts();
  </script>
</body>
</html>
